
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tool Loan Tracker</title>

  <style>
    :root {
      --brand: #0ea5e9;      /* sky-500 */
      --text: #1f2937;       /* slate-800 */
      --muted: #64748b;      /* slate-500 */
      --panel: #ffffff;      /* white panels */
      --border: #e5e7eb;     /* gray-200 */
      --accent: #22c55e;     /* green-500 */
      --frame: #475569;      /* dashed frame color */
      --corner: #0EA5E9;     /* slot corner color */
    }

    * { box-sizing: border-box; }
    html, body {
      height: 100%; margin: 0; background: #ffffff; color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }

    .topbar {
      background: var(--brand);
      color: white;
      padding: 14px 22px;
      font-size: 1.25rem;
      font-weight: 600;
      letter-spacing: 0.25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.12);
    }
    .page { max-width: 1120px; margin: 24px auto; padding: 0 22px; }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(17,24,39,0.06);
      padding: 16px;
      margin-bottom: 16px;
    }

    .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .input, .select {
      height: 40px; border-radius: 10px; border: 1px solid var(--border);
      background: #ffffff; color: var(--text); padding: 10px 12px; font-size: 0.95rem;
    }
    .input.upper { text-transform: uppercase; } /* visual uppercase */

    .btn {
      height: 40px; border-radius: 10px; padding: 0 14px; font-size: 0.95rem;
      border: 1px solid var(--border); background: #f8fafc; color: var(--text);
      cursor: pointer; transition: transform 0.06s ease, background 0.2s ease, border-color 0.2s ease;
    }
    .btn:hover { transform: translateY(-1px); background: #eef2f7; border-color: #cbd5e1; }
    .btn.primary { border-color: #16a34a; background: #def7e6; }
    .btn.primary:hover { background: #c9f0d6; }
    .btn.brand { border-color: #0284c7; background: #e0f2fe; }
    .btn.brand:hover { background: #cbe9fd; }

    /* Camera area */
    .camera-card.hidden { display: none; }
    .viewport { position: relative; width: 100%; height: min(65vh, 600px); background: #000; border-radius: 12px; overflow: hidden; }

    video#preview {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      max-width: 100%; max-height: 100%;
      width: 1000px; height: 1000px;
      object-fit: contain; background: #000; z-index: 1;
    }

    .scan-frame {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      width: min(66vw, 480px); aspect-ratio: 1 / 1; max-width: 92%;
      border: 2px dashed var(--frame); border-radius: 16px;
      display: grid; place-items: center; pointer-events: none; z-index: 2;
    }
    .scan-frame::before, .scan-frame::after { content: ""; position: absolute; inset: 0; pointer-events: none; }
    .scan-frame::before {
      background:
        linear-gradient(var(--corner), var(--corner)) left top / 24px 3px no-repeat,
        linear-gradient(var(--corner), var(--corner)) right top / 24px 3px no-repeat,
        linear-gradient(var(--corner), var(--corner)) left bottom / 24px 3px no-repeat,
        linear-gradient(var(--corner), var(--corner)) right bottom / 24px 3px no-repeat;
      border-radius: inherit;
    }
    .scan-frame::after {
      background:
        linear-gradient(var(--corner), var(--corner)) left top / 3px 24px no-repeat,
        linear-gradient(var(--corner), var(--corner)) right top / 3px 24px no-repeat,
        linear-gradient(var(--corner), var(--corner)) left bottom / 3px 24px no-repeat,
        linear-gradient(var(--corner), var(--corner)) right bottom / 3px 24px no-repeat;
      border-radius: inherit;
    }
    .hint { position: absolute; bottom: -34px; left: 50%; transform: translateX(-50%);
      color: #ffffff; font-size: 0.9rem; text-align: center; white-space: nowrap; opacity: 0.85; }

    .status { margin-top: 10px; color: var(--muted); font-size: 0.95rem; min-height: 1.4em; }
    .status.ok    { color: #16a34a; }
    .status.error { color: #ef4444; }
    .status.result{ color: #0ea5e9; }

    table { width: 100%; border-collapse: collapse; background: #ffffff; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    thead th { background: var(--brand); color: #fff; font-weight: 700; padding: 10px 12px; text-align: left; }
    tbody td { padding: 10px 12px; border-top: 1px solid var(--border); }
    tbody tr:nth-child(even) td { background: #f9fafb; }
  </style>
</head>
<body>
  <div class="topbar">Tool Loan Tracker</div>

  <div class="page">
    <!-- Entry card -->
    <div class="card">
      <div class="row" style="margin-bottom:10px;">
        <input id="toolNumber" class="input upper" type="text" placeholder="TOOL NUMBER" aria-label="Tool Number" />
        <input id="borrowerName" class="input upper" type="text" placeholder="BORROWER NAME" aria-label="Borrower Name" />
        <select id="statusSelect" class="select" aria-label="Status">
          <option value="BORROWED">BORROWED</option>
          <option value="RETURNED">RETURNED</option>
        </select>
        <button id="btnAddEntry" class="btn primary">Add Entry</button>
        <button id="btnScanBarcode" class="btn brand">Scan Barcode</button>
        <button id="btnStop" class="btn" style="display:none;">Stop Scan</button>
      </div>

      <div class="row">
        <button id="btnExport" class="btn">Export to Excel</button>
      </div>
    </div>

    <!-- Camera card (hidden until Scan) -->
    <div id="cameraCard" class="card camera-card hidden" aria-label="Camera preview">
      <div class="viewport">
        <video id="preview" autoplay playsinline muted></video>
        <div class="scan-frame" aria-hidden="true">
          <span class="hint">Center the barcode</span>
        </div>
        <div class="mask" aria-hidden="true"></div>
      </div>

      <div id="cameraStatus" class="status">Scanner idle</div>
      <div id="scanResult" class="status result"></div>
    </div>

    <!-- Log card -->
    <div class="card">
      <table aria-label="Tool Loans Table" id="loanTable">
        <thead>
          <tr>
            <th>Tool Number</th>
            <th>Borrower Name</th>
            <th>Status</th>
            <th>Timestamp</th>
          </tr>
        </thead>
        <tbody id="loanBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Single inline script: event handlers + dynamic library loading (no visible URLs shown in the page) -->
  <script>
    // ---------- Utility: safe script loader ----------
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Failed to load: ' + src));
        document.head.appendChild(s);
      });
    }

    // ---------- Local Storage helpers ----------
    const STORAGE_KEY = 'toolLoans';
    const loadEntries = () => {
      try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; }
      catch { return []; }
    };
    const saveEntries = (entries) => localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    const appendRow = (entry) => {
      const loanBody = document.getElementById('loanBody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${entry.tool}</td>
        <td>${entry.name}</td>
        <td>${entry.status}</td>
        <td>${entry.timestamp}</td>
      `;
      loanBody.appendChild(tr);
    };
    const renderAll = () => {
      const loanBody = document.getElementById('loanBody');
      loanBody.innerHTML = '';
      loadEntries().forEach(appendRow);
    };

    // ---------- App ----------
    document.addEventListener('DOMContentLoaded', () => {
      const preview     = document.getElementById('preview');
      const cameraCard  = document.getElementById('cameraCard');
      const statusEl    = document.getElementById('cameraStatus');
      const resultEl    = document.getElementById('scanResult');

      const toolInput   = document.getElementById('toolNumber');
      const nameInput   = document.getElementById('borrowerName');
      const statusSel   = document.getElementById('statusSelect');

      const btnAdd      = document.getElementById('btnAddEntry');
      const btnScan     = document.getElementById('btnScanBarcode');
      const btnStop     = document.getElementById('btnStop');
      const btnExport   = document.getElementById('btnExport');

      // Uppercase normalization
      const toUpper = e => e.target.value = (e.target.value || '').toUpperCase();
      toolInput.addEventListener('input', toUpper);
      nameInput.addEventListener('input', toUpper);

      // ---- Add Entry ----
      btnAdd.addEventListener('click', () => {
        const tool   = (toolInput.value || '').toUpperCase().trim();
        const name   = (nameInput.value || '').toUpperCase().trim();
        const status = statusSel.value;

        if (!tool || !name) {
          alert('Please enter TOOL NUMBER and BORROWER NAME.');
          return;
        }

        const timestamp = new Date().toLocaleString();
        const entry = { tool, name, status, timestamp };

        const entries = loadEntries();
        entries.push(entry);
        saveEntries(entries);
        appendRow(entry);

        // Optional: clear borrower name only
        nameInput.value = '';
      });

      // ---- Export to Excel (dynamic SheetJS load; CSV fallback) ----
      btnExport.addEventListener('click', async () => {
        const entries = loadEntries();
        if (!entries.length) { alert('No entries to export.'); return; }

        try {
          await loadScript('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');
          const data = entries.map(({tool, name, status, timestamp}) => ({
            "Tool Number": tool,
            "Borrower Name": name,
            "Status": status,
            "Timestamp": timestamp
          }));
          const ws = XLSX.utils.json_to_sheet(data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "ToolLoans");
          const fname = `tool_loans_${new Date().toISOString().slice(0,10)}.xlsx`;
          XLSX.writeFile(wb, fname);
        } catch {
          // CSV fallback (no external libs)
          const header = ["Tool Number","Borrower Name","Status","Timestamp"];
          const rows = entries.map(e => [e.tool, e.name, e.status, e.timestamp]);
          const csv = [header, ...rows].map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\r\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `tool_loans_${new Date().toISOString().slice(0,10)}.csv`;
          document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
      });

      // ---- Scan Barcode (dynamic ZXing load; multi-format) ----
      let reader = null;
      let lastText = "";

      async function startScan() {
        // Capability + secure context hint
        if (!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)) {
          statusEl.textContent = 'Camera not supported in this browser.';
          statusEl.classList.add('error');
          return;
        }

        try {
          // Request permission; prefer rear camera
          const constraints = {
            audio: false,
            video: {
              facingMode: { ideal: 'environment' },
              width:  { ideal: 1920 },
              height: { ideal: 1080 }
            }
          };
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          preview.srcObject = stream;

          // Load ZXing after stream is live
          await loadScript('https://unpkg.com/@zxing/library@latest');
          await loadScript('https://unpkg.com/@zxing/browser@latest');

          // Supported everyday product formats + common 1D/2D:
          const formats = [
            ZXing.BarcodeFormat.UPC_A,
            ZXing.BarcodeFormat.UPC_E,
            ZXing.BarcodeFormat.EAN_13,
            ZXing.BarcodeFormat.EAN_8,
            ZXing.BarcodeFormat.CODE_128,
            ZXing.BarcodeFormat.CODE_39,
            ZXing.BarcodeFormat.CODE_93,
            ZXing.BarcodeFormat.ITF,
            ZXing.BarcodeFormat.CODABAR,
            ZXing.BarcodeFormat.QR_CODE,
            ZXing.BarcodeFormat.DATA_MATRIX
          ];
          const hints = new Map();
          hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
          hints.set(ZXing.DecodeHintType.TRY_HARDER, true);

          reader = new ZXingBrowser.BrowserMultiFormatReader(hints);

          const devices = await reader.listVideoInputDevices();
          const rear = devices.find(d => /back|rear|environment/i.test(d.label || ''));
          const deviceId = rear ? rear.deviceId : (devices[0] && devices[0].deviceId) || null;

          await reader.decodeFromVideoDevice(deviceId, preview, (result, err) => {
            if (result) {
              const text = (result.getText() || "").toUpperCase();
              if (text && text !== lastText) {
                lastText = text;
                resultEl.textContent = `Decoded: ${text}`;
                resultEl.classList.add('result');
                toolInput.value = text; // auto-fill tool number
              }
            }
          });

          statusEl.textContent = 'Scanner active (UPC/EAN/Code128/Code39/ITF/Codabar, plus QR/DataMatrix)';
          statusEl.classList.remove('error');
          statusEl.classList.add('ok');
          btnStop.style.display = 'inline-block';
        } catch (err) {
          console.error(err);
          if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            statusEl.textContent = 'Scanner unavailable: serve this page over HTTPS.';
          } else {
            statusEl.textContent = 'Scanner unavailable: permission denied or no camera.';
          }
          statusEl.classList.remove('ok');
          statusEl.classList.add('error');
          btnStop.style.display = 'none';
        }
      }

      function stopScan() {
        lastText = "";
        if (reader) { reader.reset(); reader = null; }
        const stream = preview.srcObject;
        if (stream && stream.getTracks) stream.getTracks().forEach(t => t.stop());
        preview.srcObject = null;
        statusEl.textContent = 'Scanner stopped';
        statusEl.classList.remove('error', 'ok');
        btnStop.style.display = 'none';
      }

      btnScan.addEventListener('click', async () => {
        cameraCard.classList.remove('hidden');
        await startScan();
      });

      btnStop.addEventListener('click', () => {
        stopScan();
        cameraCard.classList.add('hidden');
        resultEl.textContent = '';
      });

      // Initial render
      renderAll();
    });
  </script>
</body>
</html>
